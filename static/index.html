<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Audio Survey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 1.5rem;
            line-height: 1.6;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .question {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            background: #fafafa;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }

        textarea {
            width: 100%;
            min-height: 90px;
            font-family: inherit;
            font-size: 1rem;
            padding: 0.4rem;
        }

        button {
            background: #2f6fed;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.1rem;
            font-size: 1rem;
            cursor: pointer;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Audio Survey</h1>
    <p>Please listen to the audio for each question and type your answer.</p>

    <form id="surveyForm">

        <!-- Participant name -->
        <div class="question">
            <label for="participantName">Your name</label>
            <input id="participantName" name="participantName" type="text" required
                style="width:100%;padding:0.4rem;font-size:1rem" />
        </div>


        <button type="submit" id="submitBtn">Submit</button>
    </form>

    <p id="thanks" class="hidden">Thanks for completing the survey!</p>
</body>

<script>
    /* ============================================================
       1. CONFIG: List of audio file paths
       Add as many as you want. Every one becomes a question.
       ============================================================ */
    const FILES = [
        "audio/1.wav",
        "audio/2.wav",
        "audio/3.wav",
        "audio/4.wav",
        "audio/5.wav",
        "audio/6.wav",
        "audio/7.wav",
        "audio/8.wav",
        "audio/9.wav",
        "audio/10.wav",
        "audio/11.wav",
        "audio/12.wav",
        "audio/13.wav",
        "audio/14.wav",
        "audio/15.wav",
        "audio/16.wav",
    ];

    /* ============================================================
       2. HELPER: Convert filename → safe textarea ID & name
          - Takes the last chunk after / or \
          - Removes extension
          - Replaces spaces or weird characters with underscores
       ============================================================ */
    const toId = (path) => {
        // Get filename only: splits on both / and \ (Windows & web)
        const base = path.split(/[\\/]/).pop() || "";

        // Remove file extension (.wav, .mp3, etc.)
        const noExt = base.replace(/\.[^.]+$/, "");

        // Make safe for HTML name/id: remove spaces & symbols
        return noExt.trim()
            .replace(/\s+/g, "_")
            .replace(/[^\w\-]/g, "_");
    };

    /* ============================================================
       3. HELPER: Fisher–Yates shuffle function
          - Fully randomizes order of questions
       ============================================================ */
    const shuffle = (arr) => {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    };

    /* ============================================================
       4. BUILD THE SURVEY DYNAMICALLY
       - Removes placeholder questions
       - Randomizes FILES
       - Generates <div.question> for each audio file
       ============================================================ */

    // Grab important elements from page
    const formEl = document.getElementById("surveyForm");
    const submitBtn = document.getElementById("submitBtn");
    const thanks = document.getElementById("thanks");

    // Shuffle file order
    const randomizedFiles = shuffle([...FILES]);

    // Keep the exact randomized order so backend knows which audio was which
    const questionOrder = randomizedFiles.map(src => src.replace(/\\/g, "/"));

    // Track used IDs to prevent duplicates if filenames repeat
    const usedIds = new Set();

    // Loop through each file and build a question block
    randomizedFiles.forEach((src, idx) => {
        // Make sure paths are browser-friendly (convert "\" → "/")
        const cleanSrc = src.replace(/\\/g, "/");

        // Generate a base ID from filename
        const baseId = toId(src);
        let id = baseId;

        // If multiple files share the same name, append _1, _2, etc.
        let k = 1;
        while (usedIds.has(id)) {
            id = `${baseId}_${k++}`;
        }
        usedIds.add(id);

        // Create the wrapper div.question
        const wrapper = document.createElement("div");
        wrapper.className = "question";

        // Create <audio> tag
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = cleanSrc;
        audio.textContent = "Your browser does not support the audio element.";

        // Create <textarea> with required attribute
        const textarea = document.createElement("textarea");
        textarea.id = id;
        textarea.name = id;
        textarea.required = true;

        // Insert elements into wrapper
        wrapper.appendChild(audio);
        wrapper.appendChild(textarea);

        // Place each generated question ABOVE the Submit button
        formEl.insertBefore(wrapper, submitBtn);
    });

    /* ============================================================
       5. SUBMIT HANDLER
       - Collects answers from ALL dynamically generated textareas
       - Sends them to /submit as a JSON object
       ============================================================ */
    formEl.addEventListener("submit", async (event) => {
        event.preventDefault();
        submitBtn.disabled = true;

        const payload = {
            participantName: document.getElementById("participantName").value.trim(),
            answers: {},                      // textarea answers keyed by their generated IDs
            order: questionOrder,             // exact audio order presented
            submittedAt: new Date().toISOString()
        };

        // Collect every textarea’s value
        formEl.querySelectorAll(".question textarea").forEach(t => {
            payload.answers[t.name] = t.value.trim();
        });

        try {
            const res = await fetch("/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const json = await res.json();

            if (json.ok) {
                formEl.classList.add("hidden");
                thanks.classList.remove("hidden");
                localStorage.setItem("audioSurveyDone", "1");
            } else {
                alert("There was a problem saving your response.");
                submitBtn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("Network error trying to submit.");
            submitBtn.disabled = false;
        }
    });


    /* ============================================================
       6. AUTO-HIDE FORM IF USER ALREADY COMPLETED SURVEY
       - Uses localStorage so they don't see the form again
       ============================================================ */
    if (localStorage.getItem("audioSurveyDone") === "1") {
        formEl.classList.add("hidden");
        thanks.classList.remove("hidden");
    }
</script>



</html>