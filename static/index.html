<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Audio Survey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 1.5rem;
            line-height: 1.75;
            font-size: 1.15rem;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .question {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            background: #fafafa;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }

        textarea {
            width: 100%;
            min-height: 90px;
            font-family: inherit;
            font-size: 1rem;
            padding: 0.4rem;
        }

        button {
            background: #2f6fed;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.1rem;
            font-size: 1rem;
            cursor: pointer;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

    </style>
</head>

<body>
    <h1>Audio Survey</h1>
    <section id="instructions">
        <p>
            Each song snippet below contains only synths and drums/percussion of some kind.
            To clarify, "drums/percussion" refers to any instruments that are used mainly for rhythm, such as snare drums, cymbals, and the like. Synths are electronic instruments that can produce a wide-array of sounds, but in the examples below they will typically be the more melodic instruments.
            In order to know what kind of associations and imagery are evoked by these two types of instruments, we would like you to create descriptions of characters in some kind of event, image, or situation where the characters represent the synths and the percussion.
        </p>

        <p>Here are some examples of what you might write, but I will use flutes and violins to refrain from biasing your answers:</p>

        <ol>
            <li>"The flutes and violins had a tense and dynamic conversation as they both reached peak volume."</li>
            <li>"The violins raised up the flutes to new heights as the flutes bellowed out their melody in epic triumph."
            </li>
            <li>"The tired flute lingered on the edge of the song until it could contribute no more."</li>
            <li>"The violins staggered into place, only to dart back out moments later."</li>
        </ol>

        <p>The rules are as follows:</p>

        <ol>
            <li>Your description should make you think of the instruments in terms of living beings.</li>
            <li>Write at least one sentence for each description.</li>
            <li>
                For every song snippet, you should have descriptions for both synths and drums/percussion.
                So, in the examples above, example 1 could be used alone since it describes both flutes and violins, whereas examples 3 and 4 would have to be used together since both of them only describe either flutes or violins.
            </li>
            <li>
                Not all synths or percussive elements you hear need to be described.
                So, for example, your "synth" character for a particular song snippet doesn’t have to represent all the synths you hear in that snippet.
            </li>
            <li>You can have multiple characters for each instrument if desired.</li>
            <li>The descriptions should be whatever is easiest or most rewarding to write for you.</li>
        </ol>

        <p>
            There will be a box to write any feedback you have at the end of the survey. This might include mentioning that certain song snippets were extra difficult to write descriptions for, describing how you interpreted the survey task, or anything else. 
            Please refrain from looking up the songs during the survey (such as by using Shazam).
            When the author will write their paper about these surveys, any information or examples taken from them will be referenced to without naming whichever participant they came from (so you can stay anonymous). 
        </p>
    </section>

    <form id="surveyForm">

        <!-- Participant name -->
        <div class="question">
            <label for="participantName">Your name</label>
            <input id="participantName" name="participantName" type="text" required
                style="width:100%;padding:0.4rem;font-size:1rem" />
        </div>

        <!-- Questions will insert above this -->
        <div class="question" id="feedbackContainer">
            <label for="feedback">Feedback for survey</label>
            <textarea id="feedback" name="feedback" style="min-height:120px;"></textarea>
        </div>

        <button type="submit" id="submitBtn">Submit</button>
    </form>

    <p id="thanks" class="hidden">Thanks for completing the survey!</p>
</body>

<script>
    /* ============================================================
       1. CONFIG: List of audio file paths
       Add as many as you want. Every one becomes a question.
       ============================================================ */
    const FILES = [
        "audio/1.wav",
        "audio/2.wav",
        "audio/3.wav",
        "audio/4.wav",
        "audio/5.wav",
        "audio/6.wav",
        "audio/7.wav",
        "audio/8.wav",
        "audio/9.wav",
        "audio/10.wav",
        "audio/11.wav",
        "audio/12.wav",
        "audio/13.wav",
        "audio/14.wav",
        "audio/15.wav",
        "audio/16.wav",
    ];

    /* ============================================================
       2. HELPER: Convert filename → safe textarea ID & name
          - Takes the last chunk after / or \
          - Removes extension
          - Replaces spaces or weird characters with underscores
       ============================================================ */
    const toId = (path) => {
        // Get filename only: splits on both / and \ (Windows & web)
        const base = path.split(/[\\/]/).pop() || "";

        // Remove file extension (.wav, .mp3, etc.)
        const noExt = base.replace(/\.[^.]+$/, "");

        // Make safe for HTML name/id: remove spaces & symbols
        return noExt.trim()
            .replace(/\s+/g, "_")
            .replace(/[^\w\-]/g, "_");
    };

    /* ============================================================
       3. HELPER: Fisher–Yates shuffle function
          - Fully randomizes order of questions
       ============================================================ */
    const shuffle = (arr) => {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    };

    /* ============================================================
       4. BUILD THE SURVEY DYNAMICALLY
       - Removes placeholder questions
       - Randomizes FILES
       - Generates <div.question> for each audio file
       ============================================================ */

    // Grab important elements from page
    const formEl = document.getElementById("surveyForm");
    const submitBtn = document.getElementById("submitBtn");
    const thanks = document.getElementById("thanks");

    // Shuffle file order
    const randomizedFiles = shuffle([...FILES]);

    // Keep the exact randomized order so backend knows which audio was which
    const questionOrder = randomizedFiles.map(src => src.replace(/\\/g, "/"));

    // Track used IDs to prevent duplicates if filenames repeat
    const usedIds = new Set();

    // Loop through each file and build a question block
    randomizedFiles.forEach((src, idx) => {
        // Make sure paths are browser-friendly (convert "\" → "/")
        const cleanSrc = src.replace(/\\/g, "/");

        // Generate a base ID from filename
        const baseId = toId(src);
        let id = baseId;

        // If multiple files share the same name, append _1, _2, etc.
        let k = 1;
        while (usedIds.has(id)) {
            id = `${baseId}_${k++}`;
        }
        usedIds.add(id);

        // Create the wrapper div.question
        const wrapper = document.createElement("div");
        wrapper.className = "question";

        // Add a question number label
        const numberLabel = document.createElement("div");
        numberLabel.style.fontWeight = "600";
        numberLabel.style.marginBottom = "0.5rem";
        numberLabel.textContent = `Song Snippet ${idx + 1}`;
        wrapper.appendChild(numberLabel);


        // Create <audio> tag
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = cleanSrc;
        audio.textContent = "Your browser does not support the audio element.";

        // Insert the audio first
        wrapper.appendChild(audio);

        // Single textarea input
        const label = document.createElement("label");
        label.setAttribute("for", id);
        label.textContent = "Your description";

        const ta = document.createElement("textarea");
        ta.id = id;
        ta.name = id;
        ta.required = true;

        wrapper.appendChild(label);
        wrapper.appendChild(ta);

        // Place each generated question ABOVE the feedback box
        formEl.insertBefore(wrapper, feedbackContainer);
    });

    /* ============================================================
       5. SUBMIT HANDLER
       - Collects answers from ALL dynamically generated textareas
       - Sends them to /submit as a JSON object
       ============================================================ */
 formEl.addEventListener("submit", async (event) => {
        event.preventDefault();
        submitBtn.disabled = true;

        // Remove previous highlighting
        formEl.querySelectorAll(".invalid-field").forEach(el => {
            el.classList.remove("invalid-field");
        });

        const participantName = document.getElementById("participantName").value.trim();
        if (!participantName) {
            alert("Please enter your name.");
            submitBtn.disabled = false;
            return;
        }

        // Collect answers: one textarea per audio
        const answers = {};

        formEl.querySelectorAll(".question textarea").forEach(t => {
            answers[t.name] = t.value.trim();
        });

        // Build payload
        const payload = {
            participantName,
            answers,
            order: questionOrder,
            feedback: document.getElementById("feedback").value.trim(),
            submittedAt: new Date().toISOString()
        };

        // --- SEND TO SERVER ---
        try {
            const res = await fetch("/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const json = await res.json();

            if (json.ok) {
                document.getElementById("instructions").classList.add("hidden");
                formEl.classList.add("hidden");
                thanks.classList.remove("hidden");
                localStorage.setItem("audioSurveyDone", "1");
            } else {
                alert("There was a problem saving your response.");
                submitBtn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("Network error trying to submit.");
            submitBtn.disabled = false;
        }
    });



    /* ============================================================
       6. AUTO-HIDE FORM IF USER ALREADY COMPLETED SURVEY
       - Uses localStorage so they don't see the form again
       ============================================================ */
    if (localStorage.getItem("audioSurveyDone") === "1") {
        formEl.classList.add("hidden");
        thanks.classList.remove("hidden");
    }
</script>



</html>