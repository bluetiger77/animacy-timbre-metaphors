<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Audio Survey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 1.5rem;
            line-height: 1.75;
            font-size: 1.15rem;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .question {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            background: #fafafa;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }

        textarea {
            width: 100%;
            min-height: 90px;
            font-family: inherit;
            font-size: 1rem;
            padding: 0.4rem;
        }

        button {
            background: #2f6fed;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.1rem;
            font-size: 1rem;
            cursor: pointer;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

    </style>
</head>

<body>
    <h1>Audio Survey</h1>
    <section id="instructions">
        <p>
            You will be asked to respond to a bunch of song snippets that contain only synths and percussion of some kind. Your task is to come up with an image or scene where the synths or percussion represent some kind of human or animal. 
        </p>

        <h3>What are Percussion and Synths?</h3>

        "Percussion" refers to any sounds that are used mainly for rhythm, such as clapping or hitting a drum. <br> <br>
        This video shows some examples of percussive sounds: <a href="https://www.youtube.com/shorts/Oy6A8NjAe1A" target="_blank">Percussive Sounds</a> <br> <br>
        Synths are electronic instruments that can produce a wide-array of sounds, but in the examples below they will typically be the more melodic instruments. <br> <br>
        This video shows some examples of sounds generated from synths: <a href="https://www.youtube.com/watch?v=2aH20RBHdg8&list=PLM1_74IP-VY5BCNyJNO3FT7DJT1S6wE6K" target="_blank">Synth Sounds</a>

        <h3>Your Task</h3>

        <p> 
            In order to know what kind of associations and imagery are evoked by these two types of instruments, we would like you
            to imagine some kind of event, image, or situation for both instruments (synths and percussion), where the instrument is some kind of animal or human. The idea is that you should use the instrument as inspiration for whatever imagined scene you come up with. So every song snippet will have two responses needed, one for the synths in the song and one for the percussion.
        </p>

        <h3>Examples of Possible Survey Responses</h3>

        <p>Here are some examples of what you might write as a response to a song snippet for a particular instrument:</p>

        <ol>
            <li>"A child sprinting through the wilderness without a care in the world"</li>
            <li>"An epic hero journeying through the outer fringes of space"
            </li>
            <li>"A lion roars from the depths of a valley."</li>
            <li>"Soldiers march off, with countrymen cheering them on."</li>
            <li>"A dragon falling from the sky"</li>
        </ol>

        <h3>Rules</h3>

        <ol>
            <li>
                Each song snippet requires two imagined scenarios, one for synths and one for percussion. If your imagined scenario applies to both synths and drums, such as "Two people laughing" (where one person is supposed to be the synths and the other is supposed to be the percussion), you can copy and paste your reply to both answers. If your imagined scenario applies to both instruments but you used different characters for the two instruments (such as "A knight (1st instrument) slaying a monster (2nd instrument)"), you can use parentheses to indicate which instrument the character is referring to, and then copy and paste your reply into both text boxes.
            </li>
            <li>
                Your "animals" can be any kind of animal, even mythical animals (like the dragon example above) and your "humans" can be anything human-like, such as cyborgs, elves, or any other fictional being you think has a human level of consciousness.
            </li>
            <li>
                Not all synths or percussive elements you hear need to be described.
                So, for example, your "synth" character for a particular song snippet does not have to represent all the synths you hear in that snippet, and you do not have to be clear about which synth or percussive element you are referring to.
            </li>
            <li>
                You can have multiple characters for each instrument if desired.
            </li>
            <li>
                There will be two checkboxes for each song snippet. Use these to indicate if you had difficulty coming up with a response for a particular instrument. It is okay if they are all easy or all difficult, and what counts as difficult is left for you to judge.
            </li>
            <li>
                You can listen to as much or as little of the song snippet as you need to form a reply. You can listen as many times
                as you need.
            </li>
            <li>
                The descriptions should be whatever is easiest or most rewarding to write for you. They can be as simple and short as you like, or as long and detailed as you like.
            </li>
            <li>
                Please refrain from looking up the songs during the survey (such as by using Shazam).
            </li>
        </ol>

        <h3>Additional Notes</h3>
        <p>
            There will be a box to write any feedback you have at the end of the survey, such as explaining your particular approach to the survey task. You do not have to use this if you have no feedback. <br>
            Lastly, when the author writes their paper about these surveys, any information or examples taken from the surveys will be referenced to without naming whichever participant they came from (so that you can stay anonymous). 
        </p>
    </section>

    <form id="surveyForm">

        <!-- Participant name -->
        <div class="question">
            <label for="participantName">Your name</label>
            <input id="participantName" name="participantName" type="text" required
                style="width:100%;padding:0.4rem;font-size:1rem" />
        </div>

        <!-- Questions will insert above this -->
        <div class="question" id="feedbackContainer">
            <label for="feedback">Feedback for survey</label>
            <textarea id="feedback" name="feedback" style="min-height:120px;"></textarea>
        </div>

        <button type="submit" id="submitBtn">Submit</button>
    </form>

    <p id="thanks" class="hidden">Thanks for completing the survey!</p>
</body>

<script>
    /* ============================================================
       1. CONFIG: List of audio file paths
       Add as many as you want. Every one becomes a question.
       ============================================================ */
    const FILES = [
        "audio/1.wav",
        "audio/2.wav",
        "audio/3.wav",
        "audio/4.wav",
        "audio/5.wav",
        "audio/6.wav",
        "audio/7.wav",
        "audio/8.wav",
        "audio/9.wav",
        "audio/10.wav",
    ];

    /* ============================================================
       2. HELPER: Convert filename → safe textarea ID & name
          - Takes the last chunk after / or \
          - Removes extension
          - Replaces spaces or weird characters with underscores
       ============================================================ */
    const toId = (path) => {
        // Get filename only: splits on both / and \ (Windows & web)
        const base = path.split(/[\\/]/).pop() || "";

        // Remove file extension (.wav, .mp3, etc.)
        const noExt = base.replace(/\.[^.]+$/, "");

        // Make safe for HTML name/id: remove spaces & symbols
        return noExt.trim()
            .replace(/\s+/g, "_")
            .replace(/[^\w\-]/g, "_");
    };

    /* ============================================================
       3. HELPER: Fisher–Yates shuffle function
          - Fully randomizes order of questions
       ============================================================ */
    const shuffle = (arr) => {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    };

    /* ============================================================
       4. BUILD THE SURVEY DYNAMICALLY
       - Removes placeholder questions
       - Randomizes FILES
       - Generates <div.question> for each audio file
       ============================================================ */

    // Grab important elements from page
    const formEl = document.getElementById("surveyForm");
    const submitBtn = document.getElementById("submitBtn");
    const thanks = document.getElementById("thanks");
    const instructionsEl = document.getElementById("instructions");


    // Shuffle file order
    const randomizedFiles = shuffle([...FILES]);

    // Keep the exact randomized order so backend knows which audio was which
    const questionOrder = randomizedFiles.map(src => src.replace(/\\/g, "/"));

    // Track used IDs to prevent duplicates if filenames repeat
    const usedIds = new Set();

    // Loop through each file and build a question block
    randomizedFiles.forEach((src, idx) => {
        // Make sure paths are browser-friendly (convert "\" → "/")
        const cleanSrc = src.replace(/\\/g, "/");

        // Generate a base ID from filename
        const baseId = toId(src);
        let id = baseId;

        // If multiple files share the same name, append _1, _2, etc.
        let k = 1;
        while (usedIds.has(id)) {
            id = `${baseId}_${k++}`;
        }
        usedIds.add(id);

        // Create the wrapper div.question
        const wrapper = document.createElement("div");
        wrapper.className = "question";

        // Add a question number label
        const numberLabel = document.createElement("div");
        numberLabel.style.fontWeight = "600";
        numberLabel.style.marginBottom = "0.5rem";
        numberLabel.textContent = `Song Snippet ${idx + 1}`;
        wrapper.appendChild(numberLabel);


        // Create <audio> tag
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = cleanSrc;
        audio.textContent = "Your browser does not support the audio element.";

        // Insert the audio first
        wrapper.appendChild(audio);

        // Synth textarea
        const synthLabel = document.createElement("label");
        synthLabel.setAttribute("for", `${id}__synth`);
        synthLabel.textContent = "Synths Scene";

        const synthTa = document.createElement("textarea");
        synthTa.id = `${id}__synth`;
        synthTa.name = `${id}::synth`;   // we’ll parse this later
        synthTa.required = true;

        wrapper.appendChild(synthLabel);
        wrapper.appendChild(synthTa);

        // Percussion textarea
        const percLabel = document.createElement("label");
        percLabel.setAttribute("for", `${id}__percussion`);
        percLabel.textContent = "Percussion Scene";

        const percTa = document.createElement("textarea");
        percTa.id = `${id}__percussion`;
        percTa.name = `${id}::percussion`;  // we’ll parse this later
        percTa.required = true;

        wrapper.appendChild(percLabel);
        wrapper.appendChild(percTa);

        // Difficulty checkboxes row (Synth + Percussion on one line)
        const diffRow = document.createElement("div");
        diffRow.style.marginTop = "0.8rem";
        diffRow.style.display = "flex";
        diffRow.style.flexWrap = "nowrap";
        diffRow.style.columnGap = "2rem";
        diffRow.style.alignItems = "center";

        // ---- Synth difficulty ----
        const synthWrap = document.createElement("label");
        synthWrap.style.display = "flex";
        synthWrap.style.alignItems = "center";
        synthWrap.style.gap = "0.3rem";
        synthWrap.style.whiteSpace = "nowrap";

        const synthDiff = document.createElement("input");
        synthDiff.type = "checkbox";
        synthDiff.name = `${id}::synth_difficult`;

        synthWrap.appendChild(synthDiff);
        synthWrap.appendChild(document.createTextNode("Synth difficult?"));

        // ---- Percussion difficulty ----
        const percWrap = document.createElement("label");
        percWrap.style.display = "flex";
        percWrap.style.alignItems = "center";
        percWrap.style.gap = "0.3rem";
        percWrap.style.whiteSpace = "nowrap";

        const percDiff = document.createElement("input");
        percDiff.type = "checkbox";
        percDiff.name = `${id}::perc_difficult`;

        percWrap.appendChild(percDiff);
        percWrap.appendChild(document.createTextNode("Percussion difficult?"));

        // Add both to row
        diffRow.appendChild(synthWrap);
        diffRow.appendChild(percWrap);

        wrapper.appendChild(diffRow);

        // Place each generated question ABOVE the feedback box
        formEl.insertBefore(wrapper, feedbackContainer);
    });

    /* ============================================================
       5. SUBMIT HANDLER
       - Collects answers from ALL dynamically generated textareas
       - Sends them to /submit as a JSON object
       ============================================================ */
 formEl.addEventListener("submit", async (event) => {
        event.preventDefault();
        submitBtn.disabled = true;

        // Remove previous highlighting
        formEl.querySelectorAll(".invalid-field").forEach(el => {
            el.classList.remove("invalid-field");
        });

        const participantName = document.getElementById("participantName").value.trim();
        if (!participantName) {
            alert("Please enter your name.");
            submitBtn.disabled = false;
            return;
        }

        // Collect answers: synth, percussion, and "was this hard?" per audio
        const answers = {};

        // First, gather text responses
        formEl.querySelectorAll(".question textarea").forEach(t => {
            // skip non-question fields (participantName, feedback)
            if (!t.name.includes("::")) return;

            const [baseId, field] = t.name.split("::"); // e.g., "audio_1::synth"
            if (!answers[baseId]) {
                answers[baseId] = {
                    synth: "",
                    percussion: "",
                    hard: false
                };
            }
            answers[baseId][field] = t.value.trim();
        });

        // Initialize missing entries
        const init = () => ({
            synth: "",
            percussion: "",
            synth_difficult: false,
            perc_difficult: false
        });

        // First collect text fields
        formEl.querySelectorAll(".question textarea").forEach(t => {
            if (!t.name.includes("::")) return;

            const [baseId, field] = t.name.split("::");

            if (!answers[baseId]) answers[baseId] = init();

            answers[baseId][field] = t.value.trim();
        });

        // Collect difficulty checkboxes
        formEl.querySelectorAll('.question input[type="checkbox"]').forEach(cb => {
            if (!cb.name.includes("::")) return;

            const [baseId, field] = cb.name.split("::");

            if (!answers[baseId]) answers[baseId] = init();

            answers[baseId][field] = cb.checked;
        });



        // Build payload
        const payload = {
            participantName,
            answers,
            order: questionOrder,
            feedback: document.getElementById("feedback").value.trim(),
            submittedAt: new Date().toISOString()
        };

        // --- SEND TO SERVER ---
        try {
            const res = await fetch("/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const json = await res.json();

            if (json.ok) {
                if (instructionsEl) instructionsEl.classList.add("hidden");
                formEl.classList.add("hidden");
                thanks.classList.remove("hidden");
                localStorage.setItem("audioSurveyDone", "1");
            } else {
                alert("There was a problem saving your response.");
                submitBtn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("Network error trying to submit.");
            submitBtn.disabled = false;
        }
    });



    /* ============================================================
       6. AUTO-HIDE FORM IF USER ALREADY COMPLETED SURVEY
       - Uses localStorage so they don't see the form again
       ============================================================ */
    if (localStorage.getItem("audioSurveyDone") === "1") {
        if (instructionsEl) instructionsEl.classList.add("hidden");
        formEl.classList.add("hidden");
        thanks.classList.remove("hidden");
    }
</script>



</html>